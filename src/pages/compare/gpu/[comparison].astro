---
import Layout from '../../../layouts/Layout.astro';
import gpusData from '../../../data/gpus.json';
import { getGPUComparisons, determineWinner, extractNumericValue } from '../../../utils/comparison-utils';

export async function getStaticPaths() {
	const comparisons = getGPUComparisons();
	return comparisons.map(comp => ({
		params: { comparison: comp.id },
		props: { comp }
	}));
}

const { comparison } = Astro.params;
const { comp } = Astro.props;

if (!comp) {
	return Astro.redirect('/compare/gpu');
}

const gpu1 = comp.model1;
const gpu2 = comp.model2;

const description = `Compare ${gpu1.name} vs ${gpu2.name} GPU specifications, benchmarks, and performance scores.`;

const allScoreKeys = new Set([
	...Object.keys(gpu1.scores || {}),
	...Object.keys(gpu2.scores || {})
]);

const scoreAdvantages = [];
Array.from(allScoreKeys).forEach(key => {
	const score1 = gpu1.scores?.[key];
	const score2 = gpu2.scores?.[key];
	if (score1 && score2) {
		const num1 = extractNumericValue(score1);
		const num2 = extractNumericValue(score2);
		if (num1 && num2) {
			const isHigherBetter = ['score', 'gaming', 'fps', 'tflops'].some(term => key.toLowerCase().includes(term));
			if (isHigherBetter) {
				if (num1 > num2) {
					const percentage = Math.round(((num1 - num2) / num2) * 100);
					scoreAdvantages.push({ metric: key, percentage, winner: 1 });
				} else if (num2 > num1) {
					const percentage = Math.round(((num2 - num1) / num1) * 100);
					scoreAdvantages.push({ metric: key, percentage, winner: 2 });
				}
			}
		}
	}
});

const winner = scoreAdvantages.filter(a => a.winner === 1).length > scoreAdvantages.filter(a => a.winner === 2).length ? 1 : 2;
---

<Layout title={`${gpu1.name} vs ${gpu2.name} - GPU Comparison`} description={description}>
	<div class="comparison-container">
		<div class="card">
			<div class="card-block bb-light pb flex flex-wrap">
				<div class="card-head">
					<h2 class="title-h2">Review</h2>
				</div>
				<span class="card-head-desc">Evaluation of {gpu1.name} and {gpu2.name}</span>
			</div>

			<div class="card-block">
				<div class="two-columns-container">
					<div class="two-columns">
						{Array.from(allScoreKeys).sort().map(categoryKey => {
							const score1 = gpu1.scores?.[categoryKey];
							const score2 = gpu2.scores?.[categoryKey];
							const num1 = extractNumericValue(score1);
							const num2 = extractNumericValue(score2);
							const categoryWinner = num1 && num2 ? (num1 > num2 ? 1 : num2 > num1 ? 2 : 0) : 0;
							const maxVal = Math.max(num1 || 0, num2 || 0);
							const width1 = maxVal > 0 ? Math.min(100, (num1 / maxVal) * 100) : 0;
							const width2 = maxVal > 0 ? Math.min(100, (num2 / maxVal) * 100) : 0;
							
							return (
								<div class="two-columns-item mb">
									<div>
										<div style="margin-bottom: 6px;">
											<div class="title-h4">{categoryKey}</div>
											<div class="text-gray-small">Performance metric</div>
										</div>
										<div>
											<div class="mb">
												<div class="score-bar">
													<div class="score-bar-name">
														<a href={`/gpus/${gpu1.slug.split('-')[0]}/${gpu1.slug.split('-')[1]}/${gpu1.slug}/`}>
															{gpu1.name}
														</a>
													</div>
													<div class="score-bar-result">
														<span class={`score-bar-result-square ${categoryWinner === 1 ? 'score-bar-result-square-dark' : ''}`}>
															{num1 !== undefined ? Math.round(num1) : 'N/A'}
														</span>
													</div>
													<div class="score-bar-line">
														<div class="score-bar-line-filled" style={`width: ${width1}%`}></div>
													</div>
												</div>
											</div>
											<div class="mb">
												<div class="score-bar">
													<div class="score-bar-name">
														<a href={`/gpus/${gpu2.slug.split('-')[0]}/${gpu2.slug.split('-')[1]}/${gpu2.slug}/`}>
															{gpu2.name}
														</a>
													</div>
													<div class="score-bar-result">
														<span class={`score-bar-result-square ${categoryWinner === 2 ? 'score-bar-result-square-dark' : ''}`}>
															{num2 !== undefined ? Math.round(num2) : 'N/A'}
														</span>
													</div>
													<div class="score-bar-line">
														<div class="score-bar-line-filled" style={`width: ${width2}%`}></div>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
							);
						})}
					</div>
				</div>
			</div>
		</div>
	</div>
</Layout>

<style>
	.card {
		background: #fff;
		border: 1px solid #e0e0e0;
		border-radius: 4px;
		box-shadow: 0 0 3px 0 rgba(0, 0, 0, 0.08);
		margin: 0 0 16px;
		width: 100%;
		display: flex;
		flex-direction: column;
	}

	.card-block {
		padding: 12px 16px 0;
	}

	.bb-light {
		border-bottom: 1px solid #ebebeb;
	}

	.pb {
		padding-bottom: 12px;
	}

	.flex {
		display: flex;
	}

	.flex-wrap {
		flex-wrap: wrap;
	}

	.card-head {
		display: flex;
		justify-content: center;
		align-items: center;
		margin-right: 12px;
	}

	.card-head-desc {
		color: #646464;
		font-size: 12.5px;
		line-height: 1.45em;
		margin-top: 5px;
		flex: 1 1 100%;
	}

	.title-h2 {
		font-size: 21px;
		font-weight: 600;
		line-height: 1.25em;
		margin: 0;
	}

	.title-h4 {
		font-size: 16px;
		font-weight: 600;
	}

	.text-gray-small {
		color: #646464;
		font-size: 12.5px;
	}

	.mb {
		margin-bottom: 12px;
	}

	.two-columns-container {
		width: 100%;
	}

	.two-columns {
		display: flex;
		flex-wrap: wrap;
		column-gap: 16px;
		justify-content: space-between;
	}

	.two-columns-item {
		flex: 1 1 calc(50% - 16px);
		box-sizing: border-box;
	}

	@media only screen and (max-width: 580px) {
		.two-columns-item {
			flex: 1 1 100%;
		}
	}

	.score-bar {
		display: flex;
		flex-wrap: wrap;
		justify-content: space-between;
	}

	.score-bar-name {
		width: 100%;
	}

	.score-bar-name a {
		color: #050e41;
		font-weight: 400;
		text-decoration: none;
	}

	.score-bar-name a:hover {
		color: #3949ab;
	}

	.score-bar-result {
		margin: 4px 0 0 8px;
	}

	.score-bar-result-square,
	.score-bar-result-square-dark {
		border: 1px solid #c3c5e1;
		border-radius: 3px;
		display: inline-block;
		font-weight: 500;
		line-height: 22px;
		min-width: 32px;
		padding: 0 6px;
		text-align: center;
		margin: 0 0 4px 8px;
	}

	.score-bar-result-square-dark {
		background-color: #3949ab;
		border-color: #3949ab;
		color: #fff;
	}

	.score-bar-line {
		background-color: #e6e6e8;
		border-radius: 4px;
		box-sizing: border-box;
		height: 4px;
		margin: 2px 0 0;
		overflow: hidden;
		position: relative;
		width: 100%;
	}

	.score-bar-line-filled {
		background-color: #3949ab;
		border-radius: 4px;
		display: block;
		height: 4px;
		transition: width 2s ease-in-out;
		z-index: 1;
	}

	.comparison-container {
		max-width: 730px;
		margin: 0 auto;
		padding: 12px 16px;
	}

	@media only screen and (max-width: 580px) {
		.comparison-container {
			padding: 0;
		}

		.card {
			margin: 0 0 16px;
		}
	}
</style>
