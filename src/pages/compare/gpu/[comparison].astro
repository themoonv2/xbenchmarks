---
import Layout from '../../../layouts/Layout.astro';
import gpusData from '../../../data/gpus.json';
import { getGPUComparisons, getRelatedComparisons, determineWinner, getWinnerClass, getImageUrl, formatSpecValue } from '../../../utils/comparison-utils';

export async function getStaticPaths() {
	const comparisons = getGPUComparisons();
	return comparisons.map(comp => ({
		params: { comparison: comp.id },
		props: { comp }
	}));
}

const { comparison } = Astro.params;
const { comp } = Astro.props;

if (!comp) {
	return Astro.redirect('/compare/gpu');
}

const gpu1 = comp.model1;
const gpu2 = comp.model2;

// Get related comparisons
const allComparisons = getGPUComparisons();
const relatedComparisons = getRelatedComparisons(comp, allComparisons, 10);

// Dynamically get all available scores and specs
const allScoreKeys = new Set([
	...Object.keys(gpu1.scores || {}),
	...Object.keys(gpu2.scores || {})
]);

const allSpecKeys = new Set([
	...Object.keys(gpu1.specs || {}),
	...Object.keys(gpu2.specs || {})
]);
---

<Layout title={`${gpu1.name} vs ${gpu2.name} | XBenchmarks`}>
	<div class="comparison-container">
		<div class="comparison-header">
			<h1 class="page-title">{gpu1.name} vs {gpu2.name}</h1>
		</div>

		<!-- GPUs Header Section - Side by Side -->
		<section class="comparison-header-section">
			<div class="gpu-card">
				<img 
					src={getImageUrl(gpu1.images?.main, import.meta.env.BASE_URL)} 
					alt={gpu1.name}
					class="gpu-image"
				/>
				<h2 class="gpu-name">
					<a href={`${import.meta.env.BASE_URL}/gpus/${gpu1.slug.split('-')[0]}/${gpu1.slug.split('-')[1]}/${gpu1.slug}`}>
						{gpu1.name}
					</a>
				</h2>
				<div class="gpu-meta">
					<span class="price">${gpu1.price || 'N/A'}</span>
					{gpu1.specs?.Released && <span class="released">{gpu1.specs.Released}</span>}
				</div>
			</div>

			<div class="gpu-card">
				<img 
					src={getImageUrl(gpu2.images?.main, import.meta.env.BASE_URL)} 
					alt={gpu2.name}
					class="gpu-image"
				/>
				<h2 class="gpu-name">
					<a href={`${import.meta.env.BASE_URL}/gpus/${gpu2.slug.split('-')[0]}/${gpu2.slug.split('-')[1]}/${gpu2.slug}`}>
						{gpu2.name}
					</a>
				</h2>
				<div class="gpu-meta">
					<span class="price">${gpu2.price || 'N/A'}</span>
					{gpu2.specs?.Released && <span class="released">{gpu2.specs.Released}</span>}
				</div>
			</div>
		</section>
		<!-- Score Comparison -->
		{allScoreKeys.size > 0 && (
			<section class="comparison-section">
				<h2 class="section-title">Performance Scores</h2>
				<div class="comparison-table">
					<div class="table-header">
						<div class="metric-col">Metric</div>
						<div class="value-col">{gpu1.name}</div>
						<div class="value-col">{gpu2.name}</div>
					</div>
					{Array.from(allScoreKeys).sort().map(key => {
						const score1 = gpu1.scores?.[key];
						const score2 = gpu2.scores?.[key];
						const winner = determineWinner(score1, score2, key);
						return (
							<div class="table-row">
								<div class="metric-col">{key}</div>
								<div class={`value-col ${winner === 1 ? 'winner-left' : winner === 2 ? 'winner-right' : ''}`}>
									{score1 !== undefined ? (typeof score1 === 'number' ? score1.toFixed(2) : score1) : 'N/A'}
								</div>
								<div class={`value-col ${winner === 2 ? 'winner-left' : winner === 1 ? 'winner-right' : ''}`}>
									{score2 !== undefined ? (typeof score2 === 'number' ? score2.toFixed(2) : score2) : 'N/A'}
								</div>
							</div>
						);
					})}
				</div>
			</section>
		)}

		<!-- Specifications Comparison -->
		{allSpecKeys.size > 0 && (
			<section class="comparison-section">
				<h2 class="section-title">Specifications</h2>
				<div class="comparison-table">
					<div class="table-header">
						<div class="metric-col">Specification</div>
						<div class="value-col">{gpu1.name}</div>
						<div class="value-col">{gpu2.name}</div>
					</div>
					{Array.from(allSpecKeys).sort().map(key => {
						const spec1 = gpu1.specs?.[key];
						const spec2 = gpu2.specs?.[key];
						const winner = determineWinner(spec1, spec2, key);
						
						// Format values with proper spacing
						const formatted1 = formatSpecValue(spec1);
						const formatted2 = formatSpecValue(spec2);
						
						return (
							<div class="table-row">
								<div class="metric-col">{key}</div>
								<div class={`value-col ${winner === 1 ? 'winner-left' : winner === 2 ? 'winner-right' : ''}`}>
									<Fragment set:html={formatted1} />
								</div>
								<div class={`value-col ${winner === 2 ? 'winner-left' : winner === 1 ? 'winner-right' : ''}`}>
									<Fragment set:html={formatted2} />
								</div>
							</div>
						);
					})}
				</div>
			</section>
		)}

		<!-- Related Comparisons -->
		{relatedComparisons.length > 0 && (
			<section class="comparison-section related-section">
				<h2 class="section-title">Related GPU Comparisons</h2>
				<div class="related-comparisons-grid">
					{relatedComparisons.slice(0, 10).map(rel => (
						<a href={`${import.meta.env.BASE_URL}/compare/gpu/${rel.id}`} class="related-comparison-card">
							<div class="related-item">
								<span class="item-name">{rel.model1.name}</span>
								<span class="vs">vs</span>
								<span class="item-name">{rel.model2.name}</span>
							</div>
						</a>
					))}
				</div>
			</section>
		)}
	</div>
</Layout>

<style>
	.comparison-container {
		max-width: 1200px;
		margin: 0 auto;
		padding: 2rem;
	}

	.comparison-header {
		margin-bottom: 3rem;
	}

	.page-title {
		font-size: 2.5rem;
		font-weight: 700;
		margin-bottom: 0.5rem;
	}

	.comparison-header-section {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
		gap: 2rem;
		margin-bottom: 3rem;
		padding: 2rem;
		background: var(--card-bg, #fff);
		border-radius: 12px;
		border: 1px solid var(--border-color, #eee);
	}

	.comparison-section {
		margin-bottom: 3rem;
		background: var(--card-bg, #fff);
		padding: 2rem;
		border-radius: 12px;
		border: 1px solid var(--border-color, #eee);
	}

	.related-section {
		background: var(--card-bg, #fff);
	}

	.gpu-card {
		text-align: center;
		padding: 1.5rem;
		background: var(--section-bg, #f8f9fa);
		border-radius: 8px;
		display: flex;
		flex-direction: column;
		align-items: center;
	}

	.gpu-image {
		width: 250px;
		height: 250px;
		object-fit: contain;
		margin-bottom: 1rem;
	}

	.gpu-name {
		font-size: 1.3rem;
		margin: 1rem 0;
	}

	.gpu-name a {
		color: var(--text-primary, #1a1a1a);
		text-decoration: none;
	}

	.gpu-name a:hover {
		color: var(--primary-color, #007bff);
	}

	.gpu-meta {
		display: flex;
		flex-direction: column;
		gap: 0.5rem;
		font-size: 0.9rem;
		color: var(--text-secondary, #666);
	}

	.price {
		font-weight: 600;
		color: var(--primary-color, #007bff);
	}

	.released {
		font-size: 0.85rem;
		color: var(--text-secondary, #666);
	}

	.section-title {
		font-size: 1.5rem;
		font-weight: 600;
		margin-bottom: 1.5rem;
		color: var(--text-primary, #1a1a1a);
	}

	.comparison-table {
		display: flex;
		flex-direction: column;
		border: 1px solid var(--border-color, #eee);
		border-radius: 8px;
		overflow: hidden;
	}

	.table-header,
	.table-row {
		display: grid;
		grid-template-columns: 1fr 1fr 1fr;
		border-bottom: 1px solid var(--border-color, #eee);
	}

	.table-row:last-child {
		border-bottom: none;
	}

	.table-header {
		background: var(--section-bg, #f8f9fa);
		font-weight: 600;
		color: var(--text-primary, #1a1a1a);
		border-bottom: 2px solid var(--border-color, #ddd);
	}

	.metric-col {
		padding: 1rem;
		text-align: left;
		font-weight: 500;
	}

	.table-header .metric-col {
		font-weight: 600;
	}

	.value-col {
		padding: 1rem;
		word-break: break-word;
		transition: background 0.2s ease;
	}

	.value-col.winner-left,
	.value-col.winner-right {
		background: rgba(76, 175, 80, 0.1);
		color: var(--text-primary, #1a1a1a);
	}

	.related-comparisons-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
		gap: 1rem;
	}

	.related-comparison-card {
		display: flex;
		align-items: center;
		justify-content: center;
		padding: 1.5rem;
		background: var(--section-bg, #f8f9fa);
		border: 1px solid var(--border-color, #eee);
		border-radius: 8px;
		text-decoration: none;
		transition: all 0.3s ease;
	}

	.related-comparison-card:hover {
		background: var(--primary-color, #007bff);
		color: white;
		border-color: var(--primary-color, #007bff);
	}

	.related-item {
		text-align: center;
		display: flex;
		flex-direction: column;
		gap: 0.5rem;
	}

	.item-name {
		font-weight: 600;
		font-size: 0.95rem;
		word-break: break-word;
	}

	.vs {
		font-size: 0.85rem;
		color: var(--text-secondary, #666);
		font-weight: 500;
	}

	.related-comparison-card:hover .vs {
		color: rgba(255, 255, 255, 0.8);
	}

	@media (max-width: 768px) {
		.comparison-header-section {
			grid-template-columns: 1fr;
		}

		.table-header,
		.table-row {
			grid-template-columns: 1fr;
		}

		.metric-col {
			font-weight: 600;
			background: var(--section-bg, #f8f9fa);
		}

		.page-title {
			font-size: 1.75rem;
		}

		.related-comparisons-grid {
			grid-template-columns: 1fr;
		}
	}
</style>
