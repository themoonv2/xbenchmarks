---
import Layout from '../../../layouts/Layout.astro';
import cpusData from '../../../data/cpus.json';
import { getCPUComparisons, getRelatedComparisons, determineWinner, getImageUrl, formatSpecValue, extractNumericValue } from '../../../utils/comparison-utils';

export async function getStaticPaths() {
	const comparisons = getCPUComparisons();
	return comparisons.map(comp => ({
		params: { comparison: comp.id },
		props: { comp }
	}));
}

const { comparison } = Astro.params;
const { comp } = Astro.props;

if (!comp) {
	return Astro.redirect('/compare/cpu');
}

const cpu1 = comp.model1;
const cpu2 = comp.model2;

const description = `Compare ${cpu1.name} vs ${cpu2.name} processor specs, benchmarks, and performance metrics.`;

// Get all score keys from both CPUs
const allScoreKeys = new Set([
	...Object.keys(cpu1.scores || {}),
	...Object.keys(cpu2.scores || {})
]);

// Get all spec keys from both CPUs
const allSpecKeys = new Set([
	...Object.keys(cpu1.specs || {}),
	...Object.keys(cpu2.specs || {})
]);

// Calculate score differences for conditional text
const scoreAdvantages = [];
Array.from(allScoreKeys).forEach(key => {
	const score1 = cpu1.scores?.[key];
	const score2 = cpu2.scores?.[key];
	if (score1 && score2) {
		const num1 = extractNumericValue(score1);
		const num2 = extractNumericValue(score2);
		if (num1 && num2) {
			const isHigherBetter = ['score', 'gaming', 'workstation', 'ai/ml'].some(term => key.toLowerCase().includes(term));
			if (isHigherBetter) {
				if (num1 > num2) {
					const percentage = Math.round(((num1 - num2) / num2) * 100);
					scoreAdvantages.push({ metric: key, percentage, winner: 1 });
				} else if (num2 > num1) {
					const percentage = Math.round(((num2 - num1) / num1) * 100);
					scoreAdvantages.push({ metric: key, percentage, winner: 2 });
				}
			}
		}
	}
});

// Determine overall winner
const winner = scoreAdvantages.filter(a => a.winner === 1).length > scoreAdvantages.filter(a => a.winner === 2).length ? 1 : 2;
---

<Layout title={`${cpu1.name} vs ${cpu2.name} - CPU Comparison`} description={description}>
	<div class="comparison-container">
		<div class="card">
			<div class="card-block bb-light pb flex flex-wrap">
				<div class="card-head">
					<h2 class="title-h2">Review</h2>
				</div>
				<span class="card-head-desc">Evaluation of {cpu1.name} and {cpu2.name}</span>
			</div>

			<div class="card-block">
				<div class="two-columns-container">
					<div class="two-columns">
						{/* Generate score categories dynamically */}
						{Array.from(allScoreKeys).sort().map(categoryKey => {
							const score1 = cpu1.scores?.[categoryKey];
							const score2 = cpu2.scores?.[categoryKey];
							const num1 = extractNumericValue(score1);
							const num2 = extractNumericValue(score2);
							const categoryWinner = num1 && num2 ? (num1 > num2 ? 1 : num2 > num1 ? 2 : 0) : 0;
							
							return (
								<div class="two-columns-item mb">
									<div>
										<div style="margin-bottom: 6px;">
											<div class="title-h4">{categoryKey}</div>
											<div class="text-gray-small">Performance metric</div>
										</div>
										<div>
											<div class="mb">
												<div class="score-bar">
													<div class="score-bar-name">
														<a href={`/cpus/${cpu1.slug.split('-')[0]}/${cpu1.slug.split('-')[1]}/${cpu1.slug}/`}>
															{cpu1.name}
														</a>
													</div>
													<div class="score-bar-result">
														<span class={`score-bar-result-square ${categoryWinner === 1 ? 'score-bar-result-square-dark' : ''}`}>
															{num1 !== undefined ? Math.round(num1) : 'N/A'}
														</span>
													</div>
													<div class="score-bar-line">
														<div class="score-bar-line-filled" style={`width: ${Math.min(100, (num1 / Math.max(num1 || 0, num2 || 0)) * 100)}%`}></div>
													</div>
												</div>
											</div>
											<div class="mb">
												<div class="score-bar">
													<div class="score-bar-name">
														<a href={`/cpus/${cpu2.slug.split('-')[0]}/${cpu2.slug.split('-')[1]}/${cpu2.slug}/`}>
															{cpu2.name}
														</a>
													</div>
													<div class="score-bar-result">
														<span class={`score-bar-result-square ${categoryWinner === 2 ? 'score-bar-result-square-dark' : ''}`}>
															{num2 !== undefined ? Math.round(num2) : 'N/A'}
														</span>
													</div>
													<div class="score-bar-line">
														<div class="score-bar-line-filled" style={`width: ${Math.min(100, (num2 / Math.max(num1 || 0, num2 || 0)) * 100)}%`}></div>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
							);
						})}
					</div>
				</div>
			</div>
		</div>
	</div>
</Layout>
