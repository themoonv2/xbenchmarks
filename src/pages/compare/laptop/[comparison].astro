---
import Layout from '../../../layouts/Layout.astro';
import laptopsData from '../../../data/laptops.json';
import cpusData from '../../../data/cpus.json';
import gpusData from '../../../data/gpus.json';
import { getLaptopComparisons, getRelatedComparisons, determineWinner, getWinnerClass, getImageUrl, formatSpecValue, extractNumericValue } from '../../../utils/comparison-utils';

export async function getStaticPaths() {
	const comparisons = getLaptopComparisons();
	return comparisons.map(comp => ({
		params: { comparison: comp.id },
		props: { comp }
	}));
}

const { comparison } = Astro.params;
const { comp } = Astro.props;

if (!comp) {
	return Astro.redirect('/compare/laptop');
}

const laptop1 = comp.model1;
const laptop2 = comp.model2;

// Create unique description
const description = `Compare ${laptop1.name} vs ${laptop2.name} laptop specs, performance, price, and features. Detailed side-by-side comparison to help choose the best laptop.`;

// Get related comparisons
const allComparisons = getLaptopComparisons();
const relatedComparisons = getRelatedComparisons(comp, allComparisons, 10);

// Build the H1 title with screen size if available
let h1Title = `${laptop1.name} vs ${laptop2.name}`;
const display1 = laptop1.specs?.Display || '';
const display2 = laptop2.specs?.Display || '';
const screenSize1 = display1.match(/(\d+\.?\d*)"/)?.[1] || '';
const screenSize2 = display2.match(/(\d+\.?\d*)"/)?.[1] || '';

if (screenSize1 && screenSize2) {
	if (screenSize1 === screenSize2) {
		h1Title = `${laptop1.name} vs ${laptop2.name} (${screenSize1}″)`;
	} else {
		h1Title = `${laptop1.name} (${screenSize1}″) vs ${laptop2.name} (${screenSize2}″)`;
	}
} else if (screenSize1 || screenSize2) {
	if (screenSize1) h1Title = `${laptop1.name} (${screenSize1}″) vs ${laptop2.name}`;
	else h1Title = `${laptop1.name} vs ${laptop2.name} (${screenSize2}″)`;
}

// Get all score keys from both laptops
const allScoreKeys = new Set([
	...Object.keys(laptop1.scores || {}),
	...Object.keys(laptop2.scores || {})
]);

// Get all spec keys from both laptops
const allSpecKeys = new Set([
	...Object.keys(laptop1.specs || {}),
	...Object.keys(laptop2.specs || {})
]);

// Calculate score differences for conditional text
const scoreAdvantages = [];
Array.from(allScoreKeys).forEach(key => {
	const score1 = laptop1.scores?.[key];
	const score2 = laptop2.scores?.[key];
	if (score1 && score2) {
		const num1 = extractNumericValue(score1);
		const num2 = extractNumericValue(score2);
		if (num1 && num2) {
			const isHigherBetter = ['score', 'gaming', 'performance', 'battery'].some(term => key.toLowerCase().includes(term));
			if (isHigherBetter) {
				if (num1 > num2) {
					const percentage = Math.round(((num1 - num2) / num2) * 100);
					scoreAdvantages.push({ metric: key, percentage, winner: 1 });
				} else if (num2 > num1) {
					const percentage = Math.round(((num2 - num1) / num1) * 100);
					scoreAdvantages.push({ metric: key, percentage, winner: 2 });
				}
			}
		}
	}
});


// Dynamically get all available scores and specs
// (already defined above, just need the helper functions below)

// Helper function to create CPU/GPU model link
function getCPULink(cpuName) {
	const cpu = cpusData.find(c => c.name.toLowerCase() === cpuName.toLowerCase().trim());
	if (cpu) {
		const parts = cpu.slug.split('-');
		return `${import.meta.env.BASE_URL}/cpus/${parts[0]}/${parts[1]}/${cpu.slug}`;
	}
	return null;
}

function getGPULink(gpuName) {
	const gpu = gpusData.find(g => g.name.toLowerCase() === gpuName.toLowerCase().trim());
	if (gpu) {
		const parts = gpu.slug.split('-');
		return `${import.meta.env.BASE_URL}/gpus/${parts[0]}/${parts[1]}/${gpu.slug}`;
	}
	return null;
}

// Parse CPU and GPU specs to create formatted lists with links
function formatComponentList(componentStr, isGPU = false) {
	if (!componentStr) return 'N/A';
	
	const str = componentStr.toString();
	// Remove leading "- " if present
	let content = str.replace(/^-\s*/, '').trim();
	
	// Split by various patterns
	const items = content.split(/[\n\t]+/).filter(item => item.trim());
	
	if (items.length === 0) return str;
	if (items.length === 1) return items[0];
	
	return items;
}
---

<Layout title={`${laptop1.name} vs ${laptop2.name} - Laptop Comparison`} description={description}>
	<div class="comparison-container">
		<div class="comparison-header">
			<h1 class="page-title">{h1Title}</h1>
		</div>

		<!-- Laptops Header Section - Side by Side -->
		<section class="comparison-header-section">
			<div class="laptop-card">
				<img 
					src={getImageUrl(laptop1.images?.main)} 
					alt={laptop1.name}
					class="laptop-image"
				/>
				<h2 class="laptop-name">
					<a href={`/laptop-brands/${laptop1.slug.split('-')[0]}/${laptop1.slug.split('-')[1]}/${laptop1.slug}/`}>
						{laptop1.name}
					</a>
				</h2>
				<div class="laptop-meta">
					<span class="price">${laptop1.price || 'N/A'}</span>
					{laptop1.specs?.Released && <span class="released">{laptop1.specs.Released}</span>}
				</div>
			</div>

			<div class="laptop-card">
				<img 
					src={getImageUrl(laptop2.images?.main)} 
					alt={laptop2.name}
					class="laptop-image"
				/>
				<h2 class="laptop-name">
					<a href={`/laptop-brands/${laptop2.slug.split('-')[0]}/${laptop2.slug.split('-')[1]}/${laptop2.slug}/`}>
						{laptop2.name}
					</a>
				</h2>
				<div class="laptop-meta">
					<span class="price">${laptop2.price || 'N/A'}</span>
					{laptop2.specs?.Released && <span class="released">{laptop2.specs.Released}</span>}
				</div>
			</div>
		</section>

		<!-- Score Comparison -->
		{allScoreKeys.size > 0 && (
			<section class="comparison-section">
				<h2 class="section-title">Performance Scores</h2>
				<div class="comparison-table">
					<div class="table-header">
						<div class="metric-col">Metric</div>
						<div class="value-col">{laptop1.name}</div>
						<div class="value-col">{laptop2.name}</div>
					</div>
					{Array.from(allScoreKeys).sort().map(key => {
						const score1 = laptop1.scores?.[key];
						const score2 = laptop2.scores?.[key];
						const winner = determineWinner(score1, score2, key);
						return (
							<div class="table-row">
								<div class="metric-col">{key}</div>
								<div class={`value-col ${winner === 1 ? 'winner-left' : winner === 2 ? 'winner-right' : ''}`}>
									{score1 !== undefined ? (typeof score1 === 'number' ? score1.toFixed(2) : score1) : 'N/A'}
								</div>
								<div class={`value-col ${winner === 2 ? 'winner-left' : winner === 1 ? 'winner-right' : ''}`}>
									{score2 !== undefined ? (typeof score2 === 'number' ? score2.toFixed(2) : score2) : 'N/A'}
								</div>
							</div>
						);
					})}
				</div>
			</section>
		)}

		<!-- Specifications Comparison -->
		{allSpecKeys.size > 0 && (
			<section class="comparison-section">
				<h2 class="section-title">Specifications</h2>
				<div class="comparison-table">
					<div class="table-header">
						<div class="metric-col">Specification</div>
						<div class="value-col">{laptop1.name}</div>
						<div class="value-col">{laptop2.name}</div>
					</div>
					{Array.from(allSpecKeys).sort().map(key => {
						const spec1 = laptop1.specs?.[key];
						const spec2 = laptop2.specs?.[key];
						const winner = determineWinner(spec1, spec2, key);
						
						// Special handling for CPU and GPU specs
						const isCPU = key === 'CPU' || key === 'Processor';
						const isGPU = key === 'GPU' || key === 'Graphics';
						
						let formatted1 = spec1 !== undefined ? spec1 : 'N/A';
						let formatted2 = spec2 !== undefined ? spec2 : 'N/A';
						
						if (isCPU || isGPU) {
							// Parse and format with links
							const parseList = (val) => {
								if (!val) return [];
								const str = val.toString().replace(/^-\s*/, '').trim();
								return str.split(/[\n\t]+/).filter(item => item.trim());
							};
							
							const items1 = parseList(spec1);
							const items2 = parseList(spec2);
							
							formatted1 = items1.length > 0 ? items1 : 'N/A';
							formatted2 = items2.length > 0 ? items2 : 'N/A';
						} else {
							// Use formatSpecValue for proper spacing
							formatted1 = formatSpecValue(spec1);
							formatted2 = formatSpecValue(spec2);
						}
						
						return (
							<div class="table-row">
								<div class="metric-col">{key}</div>
								<div class={`value-col ${winner === 1 ? 'winner-left' : winner === 2 ? 'winner-right' : ''}`}>
									{Array.isArray(formatted1) ? (
										<div class="component-list">
											{formatted1.map((item, idx) => {
												const link = isCPU ? getCPULink(item) : isGPU ? getGPULink(item) : null;
												return (
													<div key={idx} class="component-item">
														{link ? <a href={link}>{item}</a> : item}
													</div>
												);
											})}
										</div>
									) : (
										<Fragment set:html={formatted1} />
									)}
								</div>
								<div class={`value-col ${winner === 2 ? 'winner-left' : winner === 1 ? 'winner-right' : ''}`}>
									{Array.isArray(formatted2) ? (
										<div class="component-list">
											{formatted2.map((item, idx) => {
												const link = isCPU ? getCPULink(item) : isGPU ? getGPULink(item) : null;
												return (
													<div key={idx} class="component-item">
														{link ? <a href={link}>{item}</a> : item}
													</div>
												);
											})}
										</div>
									) : (
										<Fragment set:html={formatted2} />
									)}
								</div>
							</div>
						);
					})}
				</div>
			</section>
		)}

		<!-- Related Comparisons -->
		{relatedComparisons.length > 0 && (
			<section class="comparison-section related-section">
				<h2 class="section-title">Related Laptop Comparisons</h2>
				<div class="related-comparisons-grid">
					{relatedComparisons.slice(0, 10).map(rel => (
						<a href={`/compare/laptop/${rel.id}/`} class="related-comparison-card">
							<div class="related-item">
								<span class="item-name">{rel.model1.name}</span>
								<span class="vs">vs</span>
								<span class="item-name">{rel.model2.name}</span>
							</div>
						</a>
					))}
				</div>
			</section>
		)}
	</div>
</Layout>

<style>
	.comparison-container {
		max-width: 1200px;
		margin: 0 auto;
		padding: 2rem;
	}

	.comparison-header {
		margin-bottom: 3rem;
	}

	.page-title {
		font-size: 2.5rem;
		font-weight: 700;
		margin-bottom: 0.5rem;
	}

	.comparison-header-section {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
		gap: 2rem;
		margin-bottom: 3rem;
		padding: 2rem;
		background: var(--card-bg, #fff);
		border-radius: 12px;
		border: 1px solid var(--border-color, #eee);
	}

	.comparison-section {
		margin-bottom: 3rem;
		background: var(--card-bg, #fff);
		padding: 2rem;
		border-radius: 12px;
		border: 1px solid var(--border-color, #eee);
	}

	.related-section {
		background: var(--card-bg, #fff);
	}

	.laptop-card {
		text-align: center;
		padding: 1.5rem;
		background: var(--section-bg, #f8f9fa);
		border-radius: 8px;
		display: flex;
		flex-direction: column;
		align-items: center;
	}

	.laptop-image {
		width: 250px;
		height: 250px;
		object-fit: contain;
		margin-bottom: 1rem;
	}

	.laptop-name {
		font-size: 1.3rem;
		margin: 1rem 0;
	}

	.laptop-name a {
		color: var(--text-primary, #1a1a1a);
		text-decoration: none;
	}

	.laptop-name a:hover {
		color: var(--primary-color, #007bff);
	}

	.laptop-meta {
		display: flex;
		flex-direction: column;
		gap: 0.5rem;
		font-size: 0.9rem;
		color: var(--text-secondary, #666);
	}

	.price {
		font-weight: 600;
		color: var(--primary-color, #007bff);
	}

	.released {
		font-size: 0.85rem;
		color: var(--text-secondary, #666);
	}

	.section-title {
		font-size: 1.5rem;
		font-weight: 600;
		margin-bottom: 1.5rem;
		color: var(--text-primary, #1a1a1a);
	}

	.comparison-table {
		display: flex;
		flex-direction: column;
		border: 1px solid var(--border-color, #eee);
		border-radius: 8px;
		overflow: hidden;
	}

	.table-header,
	.table-row {
		display: grid;
		grid-template-columns: 1fr 1fr 1fr;
		border-bottom: 1px solid var(--border-color, #eee);
	}

	.table-row:last-child {
		border-bottom: none;
	}

	.table-header {
		background: var(--section-bg, #f8f9fa);
		font-weight: 600;
		color: var(--text-primary, #1a1a1a);
		border-bottom: 2px solid var(--border-color, #ddd);
	}

	.metric-col {
		padding: 1rem;
		text-align: left;
		font-weight: 500;
	}

	.table-header .metric-col {
		font-weight: 600;
	}

	.value-col {
		padding: 1rem;
		word-break: break-word;
		transition: background 0.2s ease;
	}

	.value-col.winner-left,
	.value-col.winner-right {
		background: rgba(76, 175, 80, 0.1);
		color: var(--text-primary, #1a1a1a);
	}

	.component-list {
		display: flex;
		flex-direction: column;
		gap: 0.5rem;
	}

	.component-item {
		display: block;
		padding: 0.25rem 0;
	}

	.component-item a {
		color: var(--primary-color, #007bff);
		text-decoration: none;
	}

	.component-item a:hover {
		text-decoration: underline;
	}

	.related-comparisons-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
		gap: 1rem;
	}

	.related-comparison-card {
		display: flex;
		align-items: center;
		justify-content: center;
		padding: 1.5rem;
		background: var(--section-bg, #f8f9fa);
		border: 1px solid var(--border-color, #eee);
		border-radius: 8px;
	}

	@media (max-width: 768px) {
		.comparison-container {
			padding: 1rem;
		}

		.page-title {
			font-size: 1.5rem;
		}

		.comparison-header-section {
			grid-template-columns: 1fr;
			gap: 1rem;
			padding: 1rem;
			margin-bottom: 2rem;
		}

		.comparison-section {
			padding: 1rem;
			margin-bottom: 2rem;
		}

		.table-header,
		.table-row {
			grid-template-columns: 1fr;
			gap: 0.5rem;
		}

		.metric-col,
		.value-col {
			padding: 0.75rem;
			border-right: none;
			border-bottom: 1px solid var(--border-color, #eee);
		}

		.metric-col {
			font-weight: 600;
			background: var(--section-bg, #f8f9fa);
		}

		.metric-col:last-child {
			border-bottom: none;
		}

		.value-col:last-child {
			border-bottom: none;
		}

		.laptop-image {
			max-width: 200px;
			height: 200px;
		}

		.related-comparisons-grid {
			grid-template-columns: 1fr;
			gap: 0.75rem;
		}
	}
		text-decoration: none;
		transition: all 0.3s ease;
	}

	.related-comparison-card:hover {
		background: var(--primary-color, #007bff);
		color: white;
		border-color: var(--primary-color, #007bff);
	}

	.related-item {
		text-align: center;
		display: flex;
		flex-direction: column;
		gap: 0.5rem;
	}

	.item-name {
		font-weight: 600;
		font-size: 0.95rem;
		word-break: break-word;
	}

	.vs {
		font-size: 0.85rem;
		color: var(--text-secondary, #666);
		font-weight: 500;
	}

	.related-comparison-card:hover .vs {
		color: rgba(255, 255, 255, 0.8);
	}

	@media (max-width: 768px) {
		.comparison-header-section {
			grid-template-columns: 1fr;
		}

		.table-header,
		.table-row {
			grid-template-columns: 1fr;
		}

		.metric-col {
			font-weight: 600;
			background: var(--section-bg, #f8f9fa);
		}

		.page-title {
			font-size: 1.75rem;
		}

		.related-comparisons-grid {
			grid-template-columns: 1fr;
		}
	}
</style>
