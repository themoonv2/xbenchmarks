---
import Layout from "../../../../layouts/Layout.astro";
import gpus from "../../../../data/gpus.json";
import laptops from "../../../../data/laptops.json";
import { getBrand, getSeries, slugify, getImageUrl } from "../../../../utils/data-helpers";
import { cleanSpecString, parseTGPVersion } from "../../../../utils/data-parser";

export async function getStaticPaths() {
    return gpus.map((gpu) => {
        const brand = getBrand(gpu.name);
        const series = getSeries(gpu.name);
        const modelSlug = gpu.slug || slugify(gpu.name);
        return {
            params: {
                brand: slugify(brand),
                series: slugify(series),
                model: modelSlug,
            },
            props: { gpu },
        };
    });
}

const { gpu } = Astro.props;

// Linked Laptops
const linkedLaptops = laptops
    .filter((laptop) => {
        return laptop.specs.GPU && laptop.specs.GPU.includes(gpu.name);
    })
    .slice(0, 10);

// Common Uses
const commonUses = [];
const score = parseInt(gpu.scores["NanoReview Final Score"] || "0");
const gamingScore = parseInt(gpu.scores["Gaming"] || "0");

if (gamingScore > 70) commonUses.push("AAA Gaming", "VR Ready");
else if (gamingScore > 40) commonUses.push("1080p Gaming");
if (gpu.name.includes("RTX") || gpu.name.includes("RX"))
    commonUses.push("Ray Tracing");
if (score > 80) commonUses.push("Professional Rendering", "Machine Learning");

// Spec Sections - organize specs into categories
const specSections = [
    {
        title: "Performance",
        keys: [
            "Architecture",
            "GPU Codename",
            "Base Clock",
            "Boost Clock",
            "Shading Units",
            "Tensor Cores",
            "Ray-tracing Cores",
            "FLOPS (FP32)",
            "Compute Units (Pipelines)",
        ],
    },
    {
        title: "Memory",
        keys: [
            "Memory Type",
            "Memory Size",
            "Memory Clock",
            "Effective Memory Speed",
            "Bus",
            "Memory Bandwidth",
        ],
    },
    {
        title: "Graphics APIs",
        keys: [
            "DirectX",
            "Vulkan",
            "OpenGL",
            "OpenCL",
            "CUDA",
            "Ray Tracing",
            "DLSS",
            "DisplayPort",
        ],
    },
    {
        title: "Technical",
        keys: [
            "TGP",
            "Fabrication Process",
            "Die Size",
            "Transistor Count",
            "Interface",
            "Max. Temperature",
            "Manufacturing",
            "Vendor",
            "Build",
            "Released",
        ],
    },
];

// Track which keys we've already displayed
const displayedKeys = new Set();
specSections.forEach((section) =>
    section.keys.forEach((key) => displayedKeys.add(key)),
);

// Get remaining specs that aren't in any section
const remainingSpecs = Object.entries(gpu.specs || {}).filter(
    ([key]) => !displayedKeys.has(key),
);
---

<Layout
    title={`${gpu.name} Specs & Benchmarks`}
    description={`Detailed specs and benchmarks for ${gpu.name}.`}
>
    <div class="profile-header grid">
        <div class="profile-image">
            {
                gpu.images?.main ? (
                    <img src={getImageUrl(gpu.images.main, import.meta.env.BASE_URL)} alt={gpu.name} />
                ) : (
                    <div class="placeholder-img">No Image</div>
                )
            }
        </div>

        <div class="profile-summary">
            <h1 class="profile-title">{gpu.name}</h1>
            {gpu.price && <div class="price-tag">${gpu.price}</div>}

            <div class="tags flex gap-2">
                {commonUses.map((use) => <span class="tag">{use}</span>)}
            </div>

            <div class="score-grid">
                {
                    gpu.scores &&
                        Object.entries(gpu.scores)
                            .slice(0, 6)
                            .map(([key, value]) => (
                                <div class="score-item">
                                    <span class="score-value">{value}</span>
                                    <span class="score-label">{key}</span>
                                </div>
                            ))
                }
            </div>

            <div class="brand-links mb-6">
                <span class="text-muted">Brand: </span>
                <a
                    href={`${import.meta.env.BASE_URL}/gpus/${slugify(getBrand(gpu.name))}`}
                    class="link">{getBrand(gpu.name)}</a
                >
                <span class="mx-2">/</span>
                <span class="text-muted">Series: </span>
                <a
                    href={`${import.meta.env.BASE_URL}/gpus/${slugify(getBrand(gpu.name))}/${slugify(getSeries(gpu.name))}`}
                    class="link">{getSeries(gpu.name)}</a
                >
            </div>
        </div>
    </div>

    <!-- Jump Links -->
    <nav class="jump-links">
        <span class="jump-label">QUICK JUMP:</span>
        {
            specSections.map((s) => (
                <a href={`#spec-${slugify(s.title)}`}>{s.title}</a>
            ))
        }
        {remainingSpecs.length > 0 && <a href="#spec-other">Other Specs</a>}
        {linkedLaptops.length > 0 && <a href="#linked-laptops">Laptops</a>}
    </nav>

    <!-- Detailed Specs -->
    <section class="section">
        <h2>Technical Specifications</h2>

        {
            specSections.map((section) => {
                const sectionSpecs = section.keys
                    .map((key) => [key, gpu.specs?.[key]])
                    .filter(([_, val]) => val && val !== "-");
                if (sectionSpecs.length === 0) return null;

                return (
                    <div
                        id={`spec-${slugify(section.title)}`}
                        class="spec-section"
                    >
                        <h3 class="spec-section-title">{section.title}</h3>
                        <table class="data-table">
                            <tbody>
                                {sectionSpecs.map(([key, val]) => {
                                    let displayValue;
                                    if (key === "TGP / Version" || key === "TGP") {
                                        const parsed = parseTGPVersion(val);
                                        displayValue = (
                                            <div class="tgp-values">
                                                {parsed.map((item) => (
                                                    <div class="tgp-item">{item}</div>
                                                ))}
                                            </div>
                                        );
                                    } else {
                                        displayValue = cleanSpecString(val);
                                    }
                                    return (
                                        <tr>
                                            <th>{key}</th>
                                            <td>{displayValue}</td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                );
            })
        }

        {/* Display remaining specs that don't fit in categories */}
        {
            remainingSpecs.length > 0 && (
                <div id="spec-other" class="spec-section">
                    <h3 class="spec-section-title">Other Specifications</h3>
                    <table class="data-table">
                        <tbody>
                            {remainingSpecs.map(([key, val]) => {
                                if (!val || val === "-") return null;
                                let displayValue;
                                if (key === "TGP / Version" || key === "TGP") {
                                    const parsed = parseTGPVersion(val);
                                    displayValue = (
                                        <div class="tgp-values">
                                            {parsed.map((item) => (
                                                <div class="tgp-item">{item}</div>
                                            ))}
                                        </div>
                                    );
                                } else {
                                    displayValue = cleanSpecString(val);
                                }
                                return (
                                    <tr>
                                        <th>{key}</th>
                                        <td>{displayValue}</td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            )
        }
    </section>

    {
        linkedLaptops.length > 0 && (
            <section id="linked-laptops" class="section mt-12">
                <h2>Laptops with {gpu.name}</h2>
                <div class="grid list-grid">
                    {linkedLaptops.map((l) => {
                        const b = getBrand(l.name);
                        const s = l.slug || slugify(l.name);
                        const series = getSeries(l.name);
                        return (
                            <a
                                href={`${import.meta.env.BASE_URL}/laptop-brands/${slugify(b)}/${slugify(series)}/${s}`}
                                class="mini-card"
                            >
                                <span class="font-medium">{l.name}</span>
                                {l.price && (
                                    <span class="text-sm text-muted">
                                        ${l.price}
                                    </span>
                                )}
                            </a>
                        );
                    })}
                </div>
            </section>
        )
    }
</Layout>

<style>
    .profile-header {
        grid-template-columns: 1fr;
        gap: var(--space-6);
        margin-bottom: var(--space-6);
    }

    @media (min-width: 768px) {
        .profile-header {
            grid-template-columns: 300px 1fr;
        }
    }

    .profile-image img {
        width: 100%;
        border: var(--border-primary);
        padding: var(--space-4);
        background: #fff;
        object-fit: contain;
    }

    .profile-title {
        margin-top: 0;
        font-size: var(--text-2xl);
    }

    .price-tag {
        font-size: var(--text-2xl);
        font-weight: 700;
        margin-bottom: var(--space-4);
        display: inline-block;
        padding: var(--space-2) var(--space-4);
        background: var(--color-surface);
        border: var(--border-primary);
    }

    .tags {
        flex-wrap: wrap;
        margin-bottom: var(--space-4);
    }

    .tag {
        font-size: var(--text-xs);
        border: 1px solid var(--color-border);
        padding: 2px 8px;
        border-radius: 99px;
        background: var(--color-surface);
        text-transform: uppercase;
        color: var(--text-muted);
    }

    .score-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--space-2);
        margin-top: var(--space-4);
    }

    .score-item {
        border: var(--border-primary);
        padding: var(--space-2);
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        background: #fff;
    }

    .score-value {
        font-size: var(--text-xl);
        font-weight: 700;
    }

    .score-label {
        font-size: 10px;
        color: var(--color-text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Jump Links */
    .jump-links {
        display: flex;
        gap: var(--space-4);
        padding: var(--space-3) 0;
        margin-bottom: var(--space-6);
        border-bottom: 1px solid var(--color-border);
        overflow-x: auto;
        white-space: nowrap;
        align-items: center;
    }
    .jump-label {
        font-size: var(--text-xs);
        font-weight: 700;
        color: var(--color-text-muted);
        margin-right: var(--space-2);
    }
    .jump-links a {
        text-decoration: none;
        color: var(--color-text);
        font-size: var(--text-sm);
        font-weight: 500;
        border: 1px solid transparent;
        padding: 2px 8px;
        border-radius: 4px;
    }
    .jump-links a:hover {
        background: var(--color-surface);
        border-color: var(--color-border);
    }

    /* Specs Tables */
    .spec-section {
        margin-bottom: var(--space-6);
    }
    .spec-section-title {
        font-size: var(--text-lg);
        font-weight: 600;
        margin-bottom: var(--space-4);
        border-left: 4px solid var(--color-text);
        padding-left: var(--space-3);
        background: var(--color-surface);
        padding-top: var(--space-1);
        padding-bottom: var(--space-1);
    }

    /* List Grid */
    .list-grid {
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: var(--space-4);
        margin-top: var(--space-4);
    }
    .mini-card {
        padding: var(--space-3);
        border: var(--border-primary);
        text-decoration: none;
        color: var(--color-text);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        height: 100px;
        transition: transform 0.1s;
    }
    .mini-card:hover {
        background: var(--color-surface);
        transform: translateY(-2px);
    }

    /* TGP Values */
    .tgp-values {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    .tgp-item {
        background: var(--color-surface);
        padding: 4px 8px;
        border-radius: 4px;
        font-size: var(--text-sm);
        border: 1px solid var(--color-border);
    }
</style>
