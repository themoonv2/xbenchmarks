---
import Layout from "../../../../layouts/Layout.astro";
import cpus from "../../../../data/cpus.json";
import gpus from "../../../../data/gpus.json";
import laptops from "../../../../data/laptops.json";
import { getBrand, getSeries, slugify, getImageUrl } from "../../../../utils/data-helpers";
import {
    cleanSpecString,
    parseMemoryTypes,
} from "../../../../utils/data-parser";

export async function getStaticPaths() {
    return cpus.map((cpu) => {
        const brand = getBrand(cpu.name);
        const series = getSeries(cpu.name);
        const modelSlug = cpu.slug || slugify(cpu.name);
        return {
            params: {
                brand: slugify(brand),
                series: slugify(series),
                model: modelSlug,
            },
            props: { cpu },
        };
    });
}

const { cpu } = Astro.props;

// Linked Laptops Logic
const linkedLaptops = laptops
    .filter((laptop) => {
        return laptop.specs.CPU && laptop.specs.CPU.includes(cpu.name);
    })
    .slice(0, 10);

// Common Uses
const commonUses = [];
const cores = parseInt(cpu.specs["Total Cores"] || cpu.specs["Cores"] || "0");
const score = parseInt(cpu.scores["NanoReview Final Score"] || "0");

if (score > 70) commonUses.push("High-End Gaming", "3D Rendering");
else if (score > 50) commonUses.push("Casual Gaming", "Photo Editing");
else commonUses.push("Office Work", "Web Browsing");

if (cores >= 10) commonUses.push("Heavy Multitasking");
if (cpu.name.includes("HX") || cpu.name.includes("HK"))
    commonUses.push("Workstation Performance");
if (cpu.name.includes("U ") || cpu.name.endsWith("U"))
    commonUses.push("Portable / Battery Efficient");

// Spec Sections
const specSections = [
    {
        title: "Performance",
        keys: [
            "Architecture",
            "Cores",
            "Total Cores",
            "Threads",
            "Base frequency",
            "Turbo frequency",
            "L3 Cache",
            "L2 Cache",
            "L1 Cache",
            "TGP",
            "TDP",
        ],
    },
    {
        title: "Graphics",
        keys: [
            "Integrated GPU",
            "GPU base clock",
            "GPU boost clock",
            "FLOPS",
            "Execution Units",
        ],
    },
    {
        title: "Technical",
        keys: [
            "Fabrication process",
            "Die Size",
            "Transistor Count",
            "Max. Temperature",
            "Manufacturing",
            "Vendor",
            "Released",
        ],
    },
];

// Track which keys we've already displayed
const displayedKeys = new Set();
specSections.forEach((section) =>
    section.keys.forEach((key) => displayedKeys.add(key)),
);

// Get remaining specs that aren't in any section
const remainingSpecs = Object.entries(cpu.specs || {}).filter(
    ([key]) => !displayedKeys.has(key),
);

// Helper function to parse spec values intelligently
function parseSpecValue(key, value) {
    if (!value || value === "-") return null;

    // Special handling for specific keys
    if (key === "Memory Types") {
        return parseMemoryTypes(value);
    }

    // For other specs, check if they contain " - " separator
    const cleanVal = cleanSpecString(value);
    if (cleanVal.includes(" - ") && !cleanVal.includes("http")) {
        // Split by " - " for list-like values
        return cleanVal
            .split(" - ")
            .map((s) => s.trim())
            .filter(Boolean);
    }

    return [cleanVal];
}

// Helper to find rival CPU and generate link
function getRivalLink(rivalName) {
    if (!rivalName) return null;

    // Try to find the rival in the CPU database
    const rival = cpus.find(
        (c) => c.name === rivalName || c.name.includes(rivalName),
    );

    if (rival) {
        const brand = getBrand(rival.name);
        const series = getSeries(rival.name);
        const modelSlug = rival.slug || slugify(rival.name);
        return `${import.meta.env.BASE_URL}/cpus/${slugify(brand)}/${slugify(series)}/${modelSlug}`;
    }

    return null;
}

// Helper to find GPU and generate link
function getGPULink(gpuName) {
    if (!gpuName) return null;

    // Try to find the GPU in the database
    const gpu = gpus.find(
        (g) => g.name === gpuName || g.name.includes(gpuName),
    );

    if (gpu) {
        const brand = getBrand(gpu.name);
        const series = getSeries(gpu.name);
        const modelSlug = gpu.slug || slugify(gpu.name);
        return `${import.meta.env.BASE_URL}/gpus/${slugify(brand)}/${slugify(series)}/${modelSlug}`;
    }

    return null;
}
---

<Layout
    title={`${cpu.name} Benchmark & Specs`}
    description={`Specs, benchmarks, and laptops powered by ${cpu.name}.`}
>
    <div class="profile-header grid">
        <div class="profile-image">
            {
                cpu.images?.main ? (
                    <img src={getImageUrl(cpu.images.main, import.meta.env.BASE_URL)} alt={cpu.name} />
                ) : (
                    <div class="placeholder-img">No Image</div>
                )
            }
        </div>

        <div class="profile-summary">
            <h1 class="profile-title">{cpu.name}</h1>
            {cpu.price && <div class="price-tag">${cpu.price}</div>}

            <div class="tags flex gap-2">
                {commonUses.map((use) => <span class="tag">{use}</span>)}
            </div>

            <div class="score-grid">
                {
                    cpu.scores &&
                        Object.entries(cpu.scores)
                            .slice(0, 6)
                            .map(([key, value]) => (
                                <div class="score-item">
                                    <span class="score-value">{value}</span>
                                    <span class="score-label">{key}</span>
                                </div>
                            ))
                }
            </div>

            <div class="brand-links mb-6">
                <span class="text-muted">Brand: </span>
                <a
                    href={`${import.meta.env.BASE_URL}/cpus/${slugify(getBrand(cpu.name))}`}
                    class="link">{getBrand(cpu.name)}</a
                >
                <span class="mx-2">/</span>
                <span class="text-muted">Series: </span>
                <a
                    href={`${import.meta.env.BASE_URL}/cpus/${slugify(getBrand(cpu.name))}/${slugify(getSeries(cpu.name))}`}
                    class="link">{getSeries(cpu.name)}</a
                >
            </div>
        </div>
    </div>

    <!-- Jump Links -->
    <nav class="jump-links">
        <span class="jump-label">QUICK JUMP:</span>
        {
            specSections.map((s) => (
                <a href={`#spec-${slugify(s.title)}`}>{s.title}</a>
            ))
        }
        {remainingSpecs.length > 0 && <a href="#spec-other">Other Specs</a>}
        {linkedLaptops.length > 0 && <a href="#linked-laptops">Laptops</a>}
    </nav>

    <!-- Detailed Specs -->
    <section class="section">
        <h2>Technical Specifications</h2>

        {
            specSections.map((section) => {
                const sectionSpecs = section.keys
                    .map((key) => [key, cpu.specs?.[key]])
                    .filter(([_, val]) => val && val !== "-");
                if (sectionSpecs.length === 0) return null;

                return (
                    <div
                        id={`spec-${slugify(section.title)}`}
                        class="spec-section"
                    >
                        <h3 class="spec-section-title">{section.title}</h3>
                        <table class="data-table">
                            <tbody>
                                {sectionSpecs.map(([key, val]) => {
                                    const parsed = parseSpecValue(key, val);
                                    if (!parsed) return null;

                                    return (
                                        <tr>
                                            <th>{key}</th>
                                            <td>
                                                {parsed.length > 1 ? (
                                                    <ul class="spec-list">
                                                        {parsed.map((item) => (
                                                            <li>{item}</li>
                                                        ))}
                                                    </ul>
                                                ) : (
                                                    parsed[0]
                                                )}
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                );
            })
        }

        {/* Display remaining specs that don't fit in categories */}
        {
            remainingSpecs.length > 0 && (
                <div id="spec-other" class="spec-section">
                    <h3 class="spec-section-title">Other Specifications</h3>
                    <table class="data-table">
                        <tbody>
                            {remainingSpecs.map(([key, val]) => {
                                const parsed = parseSpecValue(key, val);
                                if (!parsed) return null;

                                // Special handling for Rival Equivalent
                                if (key === "Rival Equivalent") {
                                    const rivalLink = getRivalLink(val);
                                    return (
                                        <tr>
                                            <th>{key}</th>
                                            <td>
                                                {rivalLink ? (
                                                    <a
                                                        href={rivalLink}
                                                        class="rival-link"
                                                    >
                                                        {cleanSpecString(val)}
                                                    </a>
                                                ) : (
                                                    cleanSpecString(val)
                                                )}
                                            </td>
                                        </tr>
                                    );
                                }

                                // Special handling for Integrated Graphics
                                if (key === "Integrated Graphics") {
                                    const gpuLink = getGPULink(val);
                                    return (
                                        <tr>
                                            <th>{key}</th>
                                            <td>
                                                {gpuLink ? (
                                                    <a
                                                        href={gpuLink}
                                                        class="rival-link"
                                                    >
                                                        {cleanSpecString(val)}
                                                    </a>
                                                ) : (
                                                    cleanSpecString(val)
                                                )}
                                            </td>
                                        </tr>
                                    );
                                }

                                return (
                                    <tr>
                                        <th>{key}</th>
                                        <td>
                                            {parsed.length > 1 ? (
                                                <ul class="spec-list">
                                                    {parsed.map((item) => (
                                                        <li>{item}</li>
                                                    ))}
                                                </ul>
                                            ) : (
                                                parsed[0]
                                            )}
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            )
        }
    </section>

    {
        linkedLaptops.length > 0 && (
            <section id="linked-laptops" class="section mt-12">
                <h2>Laptops with {cpu.name}</h2>
                <div class="grid list-grid">
                    {linkedLaptops.map((l) => {
                        const b = getBrand(l.name);
                        const s = l.slug || slugify(l.name);
                        const series = getSeries(l.name);
                        return (
                            <a
                                href={`${import.meta.env.BASE_URL}/laptop-brands/${slugify(b)}/${slugify(series)}/${s}`}
                                class="mini-card"
                            >
                                <span class="font-medium">{l.name}</span>
                                {l.price && (
                                    <span class="text-sm text-muted">
                                        ${l.price}
                                    </span>
                                )}
                            </a>
                        );
                    })}
                </div>
            </section>
        )
    }
</Layout>

<style>
    .profile-header {
        grid-template-columns: 1fr;
        gap: var(--space-6);
        margin-bottom: var(--space-6);
    }

    @media (min-width: 768px) {
        .profile-header {
            grid-template-columns: 300px 1fr;
        }
    }

    .profile-image img {
        width: 100%;
        border: var(--border-primary);
        padding: var(--space-4);
        background: #fff;
        object-fit: contain;
    }

    .profile-title {
        margin-top: 0;
        font-size: var(--text-2xl);
    }

    .price-tag {
        font-size: var(--text-2xl);
        font-weight: 700;
        margin-bottom: var(--space-4);
        display: inline-block;
        padding: var(--space-2) var(--space-4);
        background: var(--color-surface);
        border: var(--border-primary);
    }

    .tags {
        flex-wrap: wrap;
        margin-bottom: var(--space-4);
    }

    .tag {
        font-size: var(--text-xs);
        border: 1px solid var(--color-border);
        padding: 2px 8px;
        border-radius: 99px;
        background: var(--color-surface);
        text-transform: uppercase;
        color: var(--text-muted);
    }

    .score-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--space-2);
        margin-top: var(--space-4);
    }

    .score-item {
        border: var(--border-primary);
        padding: var(--space-2);
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        background: #fff;
    }

    .score-value {
        font-size: var(--text-xl);
        font-weight: 700;
    }

    .score-label {
        font-size: 10px;
        color: var(--color-text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Jump Links */
    .jump-links {
        display: flex;
        gap: var(--space-4);
        padding: var(--space-3) 0;
        margin-bottom: var(--space-6);
        border-bottom: 1px solid var(--color-border);
        overflow-x: auto;
        white-space: nowrap;
        align-items: center;
    }
    .jump-label {
        font-size: var(--text-xs);
        font-weight: 700;
        color: var(--color-text-muted);
        margin-right: var(--space-2);
    }
    .jump-links a {
        text-decoration: none;
        color: var(--color-text);
        font-size: var(--text-sm);
        font-weight: 500;
        border: 1px solid transparent;
        padding: 2px 8px;
        border-radius: 4px;
    }
    .jump-links a:hover {
        background: var(--color-surface);
        border-color: var(--color-border);
    }

    /* Specs Tables */
    .spec-section {
        margin-bottom: var(--space-6);
    }
    .spec-section-title {
        font-size: var(--text-lg);
        font-weight: 600;
        margin-bottom: var(--space-4);
        border-left: 4px solid var(--color-text);
        padding-left: var(--space-3);
        background: var(--color-surface);
        padding-top: var(--space-1);
        padding-bottom: var(--space-1);
    }

    .spec-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .spec-list li {
        padding: 2px 0;
    }

    .rival-link {
        color: var(--color-text);
        text-decoration: underline;
        font-weight: 500;
    }

    .rival-link:hover {
        color: var(--color-primary);
    }

    /* List Grid */
    .list-grid {
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: var(--space-4);
        margin-top: var(--space-4);
    }
    .mini-card {
        padding: var(--space-3);
        border: var(--border-primary);
        text-decoration: none;
        color: var(--color-text);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        height: 100px;
        transition: transform 0.1s;
    }
    .mini-card:hover {
        background: var(--color-surface);
        transform: translateY(-2px);
    }
</style>
